Bootstrap: docker
From: nvidia/cuda:11.8.0-devel-ubuntu20.04

%labels
    Author sri299792458
    Description CoppeliaSim + PyRep + RLBench for bimanual evaluation on UMN MSI

%environment
    # CoppeliaSim
    export COPPELIASIM_ROOT=/opt/CoppeliaSim
    export LD_LIBRARY_PATH=$COPPELIASIM_ROOT:$LD_LIBRARY_PATH
    export QT_QPA_PLATFORM_PLUGIN_PATH=$COPPELIASIM_ROOT
    
    # Display for VNC
    export DISPLAY=:1
    
    # Python
    export PATH=/opt/conda/bin:$PATH

%post
    # Prevent interactive prompts
    export DEBIAN_FRONTEND=noninteractive
    export TZ=America/Chicago
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    
    # ============================================
    # System dependencies
    # ============================================
    apt-get update && apt-get install -y \
        wget curl git unzip \
        xvfb x11vnc fluxbox \
        libgl1-mesa-glx libgl1-mesa-dri \
        libxcb-xinerama0 libxkbcommon-x11-0 \
        libxcb-icccm4 libxcb-image0 libxcb-keysyms1 \
        libxcb-randr0 libxcb-render-util0 libxcb-shape0 \
        libxcb-xfixes0 libxcb-sync1 \
        python3-dev python3-pip \
        libavcodec-dev libavformat-dev libswscale-dev \
        && rm -rf /var/lib/apt/lists/*
    
    # ============================================
    # Miniconda
    # ============================================
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh
    bash /tmp/miniconda.sh -b -p /opt/conda
    rm /tmp/miniconda.sh
    export PATH=/opt/conda/bin:$PATH
    
    # ============================================
    # CoppeliaSim V4.1.0 (required by PyRep)
    # ============================================
    cd /opt
    wget https://www.coppeliarobotics.com/files/V4_1_0/CoppeliaSim_Edu_V4_1_0_Ubuntu20_04.tar.xz
    tar -xf CoppeliaSim_Edu_V4_1_0_Ubuntu20_04.tar.xz
    mv CoppeliaSim_Edu_V4_1_0_Ubuntu20_04 CoppeliaSim
    rm CoppeliaSim_Edu_V4_1_0_Ubuntu20_04.tar.xz
    
    # Set environment for build
    export COPPELIASIM_ROOT=/opt/CoppeliaSim
    export LD_LIBRARY_PATH=$COPPELIASIM_ROOT:$LD_LIBRARY_PATH
    export QT_QPA_PLATFORM_PLUGIN_PATH=$COPPELIASIM_ROOT
    
    # ============================================
    # Python dependencies
    # ============================================
    pip install --upgrade pip
    pip install torch torchvision --index-url https://download.pytorch.org/whl/cu118
    pip install torch_geometric
    pip install pyg_lib torch_scatter torch_sparse torch_cluster torch_spline_conv -f https://data.pyg.org/whl/torch-2.1.0+cu118.html
    pip install numpy pillow pyquaternion natsort cffi
    pip install pytorch-lightning wandb omegaconf hydra-core
    pip install pyvista open3d trimesh scipy
    
    # ============================================
    # PyRep (will be bound from host at runtime)
    # ============================================
    # PyRep requires COPPELIASIM_ROOT to be set during build
    # We'll install it at runtime from the bound directory
    
    # ============================================
    # Cleanup
    # ============================================
    apt-get clean
    pip cache purge

%runscript
    # Start Xvfb (virtual framebuffer)
    Xvfb :1 -screen 0 1280x1024x24 &
    sleep 2
    
    # Start VNC server
    x11vnc -display :1 -forever -nopw -rfbport 5900 &
    sleep 1
    
    # Start window manager
    fluxbox &
    sleep 1
    
    echo "==================================="
    echo "VNC server running on port 5900"
    echo "Connect via: ssh -L 5900:<node>:5900 user@agate.msi.umn.edu"
    echo "Then open VNC viewer to localhost:5900"
    echo "==================================="
    
    exec "$@"
